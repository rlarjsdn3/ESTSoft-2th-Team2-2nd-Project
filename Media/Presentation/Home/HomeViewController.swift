
import UIKit
import AVKit
import AVFoundation


final class HomeViewController: StoryboardViewController {
    private var selectedVideoURL: URL?

    private var observation: NSKeyValueObservation?


    @IBAction func SearchButton(_ sender: Any) {
        let storyboard = UIStoryboard(name: "SearchViewController", bundle: nil)
        if let searchVC = storyboard.instantiateViewController(withIdentifier: "SearchViewController") as? SearchViewController {
            navigationController?.pushViewController(searchVC, animated: true)
        }
    }

    @IBOutlet weak var categoryCollectionView: UICollectionView!

    // Ï¥àÍ∏∞Í∞íÏÑ§Ï†ï
    var selectedCategoryIndex: Int = 0

    // ÏûÑÏãú ÏΩîÎìú ÏàòÏ†ïÏòàÏ†ï
    var selectedCategories: [String] = ["Flower", "Nature", "Animals", "Travel", "Food"]

    // Ïπ¥ÌÖåÍ≥†Î¶¨ Î∞∞Ïó¥ ÏàúÏÑú
    var displayedCategories: [String] {

        return ["All"] + selectedCategories
    }

    // ÌïÑÌÑ∞ÎßÅ ÏÜåÎ¨∏ÏûêÎ°ú ÎπÑÍµê
    var selectedCategoryName: String? {
        if selectedCategoryIndex == 0 {
            return nil
        }
        return selectedCategories[selectedCategoryIndex - 1].lowercased()
    }

    @IBOutlet weak var videoCollectionView: UICollectionView!

    //Parameter : Pull to Refresh Í∏∞Îä•
    @objc private func handleRefresh() {
        guard videoCollectionView.refreshControl?.isRefreshing == true else { return }

        fetchVideo()
    }

    let service = DefaultDataTransferService()

    // Pixabay APIÏóêÏÑú Î∞õÏïÑÏò® ÎπÑÎîîÏò§ Îç∞Ïù¥ÌÑ∞ Î∞∞Ïó¥
    private var videos: [PixabayResponse.Hit] = []

    override func viewDidLoad() {
        super.viewDidLoad()

        //AVAudioSession ÏÑ§Ï†ï
        do {
            try AVAudioSession.sharedInstance().setCategory(.playback, mode: .default)
            try AVAudioSession.sharedInstance().setActive(true)
        } catch {
            print("AVAudioSession ÏÑ§Ï†ï Ïã§Ìå®: \(error)")
        }
        // CollectionView Îç∏Î¶¨Í≤åÏù¥Ìä∏ & Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§
        videoCollectionView.contentInsetAdjustmentBehavior = .never

        categoryCollectionView.delegate = self
        categoryCollectionView.dataSource = self
        categoryCollectionView.register(UINib(nibName: "CategoryCell", bundle: nil), forCellWithReuseIdentifier: "CategoryCell")

        categoryCollectionView.contentInset = UIEdgeInsets(top: 0, left: 8, bottom: 0, right: 4)

        videoCollectionView.delegate = self
        videoCollectionView.dataSource = self
        videoCollectionView.register(UINib(nibName: "VideoCell", bundle: nil), forCellWithReuseIdentifier: "VideoCell")

        videoCollectionView.contentInset = .zero

        if let layout = videoCollectionView.collectionViewLayout as? UICollectionViewFlowLayout {
            layout.sectionInset = .zero
            layout.minimumInteritemSpacing = 0
            layout.minimumLineSpacing = 0
            layout.invalidateLayout()
        }
        //Pull to Refresh Í∏∞Îä•
        let  refreshControl = UIRefreshControl()
        refreshControl.addTarget(self, action: #selector(handleRefresh), for: .valueChanged)
        videoCollectionView.refreshControl = refreshControl

        fetchVideo()


    }


    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        navigationController?.setNavigationBarHidden(false, animated: animated)
    }

    // "mm:ss" ÌòïÏãùÏúºÎ°ú Î¨∏ÏûêÏó¥ Î≥ÄÌôò
    func formatDuration(seconds: Int) -> String {
        let minutes = seconds / 60
        let remainingSeconds = seconds % 60
        return String(format: "%02d:%02d", minutes, remainingSeconds)
    }
        // ÎπÑÎîîÏò§ Ïû¨ÏÉù
        func playVideo(with url: URL) {
            print("‚ñ∂Ô∏è playVideo called with URL: \(url.absoluteString)")
            // #1. PlayerItem ÏÉùÏÑ±
            let item = AVPlayerItem(url: url)
            print("üîπ AVPlayerItem created")
            // #2. Player ÏÉùÏÑ±
            let player = AVPlayer(playerItem: item)
            print("üîπ AVPlayer created")
            // #3. PlayerVC ÏÉùÏÑ±
            let vc = AVPlayerViewController()
            print("üîπ AVPlayerViewController created")
            // #4. Ïó∞Í≤∞
            vc.player = player
            print("üîπ Player connected to PlayerViewController")
            // #5. ÌëúÏãú
            present(vc, animated: true) {
                print("üîπ PlayerViewController presented")
            }

            observation?.invalidate()
            print("üîπ Previous observation invalidated")

            observation = item.observe(\.status) { playerItem, _ in
                print("üî∏ PlayerItem status changed: \(playerItem.status.rawValue)")

                if playerItem.status == .readyToPlay {
                    print("‚úÖ PlayerItem is ready to play, starting playback")

                    player.play()
                } else if playerItem.status == .failed {
                    print("‚ùå PlayerItem failed to load")
                }
            }

        }

        // ÏÑ†ÌÉùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê Îî∞Îùº Pixabay APIÏóêÏÑú ÎπÑÎîîÏò§ Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠
        func fetchVideo() {
            let query = selectedCategoryName

            let endpoint = APIEndpoints.pixabay(
                query: query,
                category: nil,
                order: .popular,
                page: 1,
                perPage: 20
            )


            let startTime = Date()

            service.request(endpoint) { [weak self] result in
                DispatchQueue.main.async {
                    guard let  self = self else { return }
                    // Refresh ÎîúÎ†àÏù¥ Ï∂îÍ∞Ä
                    let elapsed = Date().timeIntervalSince(startTime)
                    let delay = max(0.5 - elapsed, 0)

                    DispatchQueue.main.asyncAfter(deadline: .now() + delay) {
                        self.videoCollectionView.refreshControl?.endRefreshing()


                        switch result {
                        case .success(let response):
                            var fetchedVideos = response.hits

                            if let selectedCategory = self.selectedCategoryName {
                                // ÏÑ†ÌÉùÌïú Ïπ¥ÌÖåÍ≥†Î¶¨(ÏÜåÎ¨∏Ïûê)
                                let filterCategory = selectedCategory.lowercased()
                                // Ï≤´Î≤àÏß∏ ÌÉúÍ∑∏ Í∏∞Ï§Ä ÌïÑÌÑ∞ÎßÅ
                                fetchedVideos = fetchedVideos
                                    .filter { hit in
                                        let tags = hit.tags.split(separator: ",")
                                            .map { $0.trimmingCharacters(in: .whitespacesAndNewlines)
                                                    .lowercased()
                                            }
                                        return tags.contains(filterCategory)
                                    }
                            }
                            self.videos = fetchedVideos
                            self.categoryCollectionView.reloadData()
                            self.videoCollectionView.reloadData()

                        case .failure(let error):
                            print(error)
                        }
                    }
                }
            }
        }

        // Ïû¨ÏÉùÎ™©Î°ù ÎπÑÏñ¥ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨
        var playlistIsEmmpty: Bool = false



        override func viewDidAppear(_ animated: Bool) {
            super.viewDidAppear(animated)

            // ÌÖåÏä§Ìä∏Ïö©
            //                if let testURL = URL(string: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4") {
            //                    playVideo(with: testURL)
            //                }

            //        if let testURL = URL(string: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4") {
            //            playVideo(with: testURL)
            //        }

            //        if let testURL = URL(string: "https://kxc.blob.core.windows.net/est2/video-vert.mp4") {
            //            playVideo(with: testURL)
            //        }
        }
    }


extension HomeViewController: UICollectionViewDelegate {
    func collectionView(_ collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath) {
        if collectionView == categoryCollectionView {
            // ÏÑ†ÌÉùÌïú Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù∏Îç±Ïä§ ÏóÖÎç∞Ïù¥Ìä∏
            selectedCategoryIndex = indexPath.item
            // Ïπ¥ÌÖåÍ≥†Î¶¨ Ïª¨Î†âÏÖòÎ∑∞ Îã§Ïãú Í∑∏Î¶¨Í∏∞ (ÏÑ†ÌÉù ÏÉÅÌÉú Î∞òÏòÅ)
            categoryCollectionView.reloadData()
            // ÏÑ†ÌÉùÌïú Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê ÎßûÏ∂∞ ÎπÑÎîîÏò§ Ïû¨ÏöîÏ≤≠
            fetchVideo()
        } else if collectionView == videoCollectionView {

        }
    }
}

extension HomeViewController: UICollectionViewDataSource {
    func collectionView(_ collectionView: UICollectionView, numberOfItemsInSection section: Int) -> Int {
        if collectionView == videoCollectionView {
            return videos.count
        }
        return displayedCategories.count
    }

    func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -> UICollectionViewCell {

        if collectionView == videoCollectionView {
            let cell = collectionView.dequeueReusableCell(withReuseIdentifier: "VideoCell", for: indexPath) as! VideoCell
            let video = videos[indexPath.item]

            let viewModel = VideoCellViewModel(
                title: video.user,
                viewCount: video.views,
                duration: video.duration,
                thumbnailURL: video.videos.medium.thumbnail,
                profileImageURL: video.userImageUrl,
                likeCount: video.likes,
                tags: video.tags
            )

            cell.configure(with: viewModel)

            // Ïç∏ÎÑ§Ïùº ÌÑ∞ÏπòÏãú ÏòÅÏÉÅ Ïû¨ÏÉù
            cell.onThumbnailTap = { [weak self] in
                guard let self = self, let videoURL = video.videos.medium.url else { return }
                self.playVideo(with: videoURL)
            }

            // Ellipsis Î≤ÑÌäº Ïã§Ìñâ
            cell.configureMenu(
                bookmarkAction: { [weak self] in
                    guard let self = self else { return }
                    // Ïã§Ï†ú Î∂ÅÎßàÌÅ¨ Ï≤òÎ¶¨ ÏΩîÎìú
                    // let toast = Toast.makeToast("Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§", systemName: "checkmark").present()
                },
                playlistAction: { [weak self] in
                    guard let self = self else { return }
                    // Ïû¨ÏÉùÎ™©Î°ù Ï∂îÍ∞Ä Ï≤òÎ¶¨ ÏΩîÎìú
                },
                deleteAction: { [weak self] in
                    guard let self = self else { return }
                    // ÏÇ≠Ï†ú Ï≤òÎ¶¨ ÏΩîÎìú
                },
                cancelAction: {

                }
            )
            return cell
        }

        if collectionView == categoryCollectionView {
            let cell = collectionView.dequeueReusableCell(withReuseIdentifier: "CategoryCell", for: indexPath) as! CategoryCell

            let title = displayedCategories[indexPath.item]
            let isSelected = (indexPath.item == selectedCategoryIndex)
            cell.configure(with: title.capitalized, selected: isSelected)
            return cell
        }
        fatalError("Unknown collection view")
    }
}

extension HomeViewController: UICollectionViewDelegateFlowLayout {


    func collectionView(_ collectionView: UICollectionView, layout collectionViewLayout: UICollectionViewLayout,
                        sizeForItemAt indexPath: IndexPath) -> CGSize {

        if collectionView == videoCollectionView {
            let width = collectionView.bounds.width
            let height = width * 9 / 16 + 60
            return CGSize(width: width, height: height)
        }

        // Ïπ¥ÌÖåÍ≥†Î¶¨
        let text = displayedCategories[indexPath.item]
        let font = UIFont.systemFont(ofSize: 16)
        let width = text.size(withAttributes: [.font: font]).width + 32
        return CGSize(width: width, height: 40)
    }

    func collectionView(_ collectionView: UICollectionView, layout collectionViewLayout: UICollectionViewLayout,
                        insetForSectionAt section: Int) -> UIEdgeInsets {
        return .zero
    }

    func collectionView(_ collectionView: UICollectionView, layout collectionViewLayout: UICollectionViewLayout,
                        minimumInteritemSpacingForSectionAt section: Int) -> CGFloat {
        return 0
    }

    func collectionView(_ collectionView: UICollectionView, layout collectionViewLayout: UICollectionViewLayout,
                        minimumLineSpacingForSectionAt section: Int) -> CGFloat {
        return 8
    }
}

